var HNAP=new HNAP_XML();var xml_GetNetworkSettings=HNAP.GetXML("GetNetworkSettings");var xml_GetGuestZoneRouterSettings=HNAP.GetXML("GetGuestZoneRouterSettings");var lanip=xml_GetNetworkSettings.Get("GetNetworkSettingsResponse/IPAddress");var guestzone_ip=xml_GetGuestZoneRouterSettings.Get("GetGuestZoneRouterSettingsResponse/IPAddress");var submask=xml_GetNetworkSettings.Get("GetNetworkSettingsResponse/SubnetMask");var mask=COMM_IPv4MASK2INT(submask);var xml_GetWanSettings=HNAP.GetXML("GetWanSettings");var wan_type_init=xml_GetWanSettings.Get("GetWanSettingsResponse/Type");var xml_GetClientSettings=HNAP.GetXML("GetClientInfo");var Reserved_cnt=xml_GetClientSettings.Get("GetClientInfoResponse/Reserved_cnt");var xml_GetMacFilterSettings=HNAP.GetXML("GetMACFilters2");var MACFilter_cnt=xml_GetMacFilterSettings.Get("GetMACFilters2Response/MACFilter_cnt");function Datalist(){this.list=new Array();this.maxrowid=0}Datalist.prototype={get length(){return this.list.length},set length(a){if(parseInt(a,10)>=0){this.list.length=parseInt(a,10)}}};Datalist.prototype.prepareUpdate=function(){for(var a in this.list){this.list[a].Live=false}};Datalist.prototype.getData=function(b){var a;var c;for(a=0;a<this.list.length;a++){c=this.list[a];if(c.rowid==b){break}}return c};Datalist.prototype.getDataRowNumByMac=function(e){var b;var c=null;var d=null;var a=e.toLowerCase();for(b=0;b<this.list.length;b++){c=this.list[b];if(c.MacAddress.toLowerCase()==a){d=b;break}}return d};Datalist.prototype.getRowNum=function(a){var b=0;for(b=0;b<this.list.length;b++){if(a==this.list[b].rowid){break}}return b};Datalist.prototype.editData=function(c,b){var a=this.list[this.getRowNum(c)];a.IPv4Address=b.IPv4Address;a.IPv6Address=b.IPv6Address;a.Type=b.Type;a.DeviceName=b.DeviceName;a.NickName=b.NickName;a.ReserveIP=b.ReserveIP;a.Band=b.Band;a.SignalLevel=b.SignalLevel;a.Vendor=b.Vendor;a.ScheduleName=b.ScheduleName;a.MacfilterEnabled=b.MacfilterEnabled;a.Status=b.Status;a.Live=true;return true};Datalist.prototype.deleteData=function(b){var a=this.getRowNum(b);this.list.splice(a,1)};Datalist.prototype.push=function(a){a.setRowid(this.maxrowid);this.list.push(a);this.maxrowid++;this.list.sort(function(d,c){function e(b){if(b=="LAN"){return 0}else{if(b.toUpperCase().indexOf("WIFI_")>=0){return 1}else{return 2}}}return e(d.Type)-e(c.Type)});return true};Datalist.prototype.clean=function(){for(var a in this.list){obj=this.list[a];if(obj.Live==false){this.list.splice(a,1)}}};function Data(c,g,b,f,e,h,i,a,d){this.MacAddress=c;this.IPv4Address=g;this.IPv6Address=b;this.Type=f;this.DeviceName=e;this.NickName=h;this.ReserveIP=i;this.Band=a;this.SignalLevel=d;this.Vendor=getVendor(c);this.ScheduleName="Always";this.MacfilterEnabled=false;this.Status=false;this.Live=true}Data.prototype={get NickName(){if(this._NickName==""){return this.DeviceName}return this._NickName},set NickName(a){this._NickName=a;if(a==this.DeviceName){this._NickName=""}},get ScheduleName(){return this._ScheduleName},set ScheduleName(a){if((a=="")||(a.toLowerCase()=="always")){this._ScheduleName="Always"}else{this._ScheduleName=a}},setRowid:function(a){this.rowid=a},showClientInfo:function(){var o=this;var b=o.NickName;var d="";var i;var j="link_IconE_";var h="client_Name";var l=o.IPv4Address;var f=o.Band;var n=o.Vendor;var a="";var g="";var m="false";var k="false";if(Reserved_cnt>=24){m="true"}if(MACFilter_cnt>=24){k="true"}if(wan_type_init.indexOf("Bridged")<0&&wan_type_init.indexOf("Ap")<0&&wan_type_init.indexOf("Extender")<0&&wan_type_init.indexOf("Repeater")<0){if(o.Type=="New"){if(m=="false"||k=="false"){var e='<td><div class ="client_add_Tag" onclick ="addData()" style ="cursor:pointer"></div></td>';return e}}}if(typeof(o.MacAddress)=="undefined"||o.MacAddress.length==0){return""}if(b==""||escape(b).indexOf("%u")>=0){b="Unknown"}else{b=decode_char_text(b)}if(f=="2.4GHz"){j="link_IconW_"}else{if(f=="Pri.5GHz"||f=="5GHz"){j="link_IconW5g_"}else{if(f=="Sec.5GHz"){j="link_IconW5g2_"}}}var c=o.Type.toUpperCase();if(c=="OFFLINE"){j="link_Offline_";h+=" client_Name_Offline";l=o.ReserveIP}if(o.MacfilterEnabled){a="client_Access_enable";d=I18N("j","Enabled");i="#FF0000";if((o.Type=="Blocked")||(o.Status)){if(f=="2.4GHz"||f=="5GHz"||f=="Pri.5GHz"||f=="Sec.5GHz"){j="link_IconW_Block"}else{j+="Block"}}else{j+="Allow"}}else{a="client_Access";d=I18N("j","Disabled");i="#000000";j+="Allow"}if(n.length>22){n=n.substr(0,19)+"..."}if(o.SignalLevel=="low"){g="client_Signal_Lv1"}else{if(o.SignalLevel=="mid"){g="client_Signal_Lv2"}else{if(o.SignalLevel=="high"){g="client_Signal_Lv3"}else{if(o.SignalLevel=="high+"){g="client_Signal_Lv4"}}}}var e='<td><div class ="client_Tag" style ="cursor:default"><div class ="'+j+'"></div><div class ="client_Info"><div class ="'+h+'">'+HTMLEncode(b)+'</div><div class ="client_EditImage" onclick ="editData('+o.rowid+')" style ="cursor:pointer"></div><div class ="client_Vender">'+n+'</div><div class ="client_IPv4Address">'+l+'</div><div class ="client_IPv6Address" id="IPv6Address_Client_'+o.rowid+'" title="'+o.IPv6Address+'">'+o.IPv6Address+'</div><div class ="'+a+'"></div><div class ="'+g+'"></div></div></div></td>';return e}};var tmpXML_ScheduleCnt;var Client_Type="Host";var datalist=new Datalist();var macList="";var editType=true;var editID="";var reserve_change=false;var macctrl_change=false;function LoadMACList(){$.ajax({url:"/js/MacList.json",type:"GET",dataType:"json",success:function(a){macList=a}})}function Base92(b){var a=92;function e(g){if((g+35)==92){return"!"}return String.fromCharCode(g+35)}var d=Math.floor(b/a);var c=b%a;var f="";if(d>=a){f+=Base92(d)}else{f+=e(d)}f+=e(c);return f}function getVendor(f){var d="Unknown Vendor";var e;if((typeof macList=="undefined")||(macList=="")){return d}var c=f.split(":");var b=Base92(parseInt(c[0],16));var a=Base92(parseInt(c[1]+c[2],16));if(typeof macList[b]=="undefined"||typeof macList[b][a]=="undefined"){e=d}else{e=macList[b][a]}if(typeof e=="undefined"){e=d}return decode_char_text(e)}function Get_ClientInfo(){var b=$.Deferred();var f=new SOAPGetClientInfoResponse();var e=new SOAPGetMACFilters2Response();var c=new SOAPAction();var a=c.sendSOAPAction("GetClientInfo",null,f);var d=null;if(currentState=="clientInfo"){d=c.sendSOAPAction("GetMACFilters2",null,e)}$.when(a,d).done(function(j){datalist.prepareUpdate();for(var q in datalist.list){var j=datalist.list[q];if(j.Type=="Blocked"){j.Live=true}if(j.Type=="New"){j.Live=true;datalist.deleteData(j.rowid)}}for(var g in f.ClientInfoLists.ClientInfo){var h=f.ClientInfoLists.ClientInfo[g];var k=new Data(h.MacAddress,h.IPv4Address,h.IPv6Address,h.Type,h.DeviceName,h.NickName,h.ReserveIP,h.Band,h.SignalLevel);var p=datalist.getDataRowNumByMac(h.MacAddress);if(p!=null){datalist.editData(datalist.list[p].rowid,k)}else{datalist.push(k)}}datalist.clean();var o=new Data("","","","New","","","","","");datalist.push(o);if(currentState=="clientInfo"){var m=false;datalist.prepareUpdate();for(var q in datalist.list){var j=datalist.list[q];if(j.Type!="Blocked"){j.Live=true}}for(var i in e.MACList.MACInfo){var n=e.MACList.MACInfo[i];var p=datalist.getDataRowNumByMac(n.MacAddress);if(p!=null){datalist.list[p].MacfilterEnabled=true;datalist.list[p].ScheduleName=decode_char_text(n.ScheduleName);if(n.Status=="true"||(n.ScheduleName==""&&n.Status=="false")){datalist.list[p].Status=true;datalist.list[p].Type="Blocked";m=true}datalist.list[p].Live=true}else{var k=new Data(n.MacAddress,"","","LAN",n.DeviceName,"","","");k.MacfilterEnabled=true;k.ScheduleName=decode_char_text(n.ScheduleName);k.Type="Blocked";if(n.Status=="true"){k.Status=true}datalist.push(k);m=true}}datalist.clean();showClientTypeBtn("block",m);showClientLists(Client_Type)}var l=0;for(var g in f.ClientInfoLists.ClientInfo){if(f.ClientInfoLists.ClientInfo[g].Type!="OFFLINE"){l++}}$("#Total_ConnectedClients").html(l);b.resolve()});return b.promise()}function showClientLists(c){$(document).tooltip("disable");$(document).tooltip("enable");var b=0;var a='<table class="block" border="0" ondragstart="return false" onselectstart="return false" width="900px"><tbody><tr style="height:120px">';for(var e in datalist.list){var d=datalist.list[e];if(c=="Guest"){if(d.Type.toLowerCase().indexOf("guest")<0){continue}}else{if(c=="Host"){if(d.Type.toLowerCase().indexOf("guest")>=0){continue}if(d.Type=="Blocked"){continue}}else{if(c=="Blocked"){if(d.Type!="Blocked"){continue}}}}b++;a+=d.showClientInfo();if(b%3==0){a+="</tr><tr style='height:120px'>"}}a+="</tr></tbody>";$("#Client_Group").html(a);if(b>0){$("#Client_Info").hide()}else{if(c=="Blocked"){showClientTypeBtn("block",false);showClientLists("Host")}else{$("#Client_Info").show()}}$("#Client_Group").css("display","table-row")}function addData(){changeTimeoutAction();$("#popTitle").html(I18N("j","Add Rule"));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);$("#show_Vendor").hide();$("#client_MACAddress").hide();$("#show_editMac").show();$("#show_IPAdr").hide();$("#show_IPAdrReserve").hide();$("#enableReserveIP").prop("checked",false);$("#enableAccess").prop("checked",false);$("#show_Schedule").hide();$("#editPop").show();editType=false;editID="";document.getElementById("MACAddress_Info").innerHTML="";document.getElementById("IPAdrReserve_Info").style.display="none";document.getElementById("show_IPAdrReserveAlerInfo").style.display="none"}function editData(c){changeTimeoutAction();$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);$("#popTitle").html(I18N("j","Edit Rule"));$("#show_Vendor").show();$("#client_MACAddress").show();$("#show_editMac").hide();$("#show_IPAdr").show();var b=datalist.getData(c);var a=b.IPv4Address;document.getElementById("MACAddress_Info").innerHTML="";document.getElementById("IPAdrReserve_Info").style.display="none";document.getElementById("client_IPAdrReserve").value=b.ReserveIP;document.getElementById("client_MACAddress").innerHTML=b.MacAddress;if(escape(b.NickName).indexOf("%u")>=0){$("#client_Name").val("Unknown")}else{$("#client_Name").val(decode_char_text(b.NickName))}if(a==""){a=I18N("j","Not Available")}$("#client_IPAdr").html(a);if(b.ReserveIP==""){reserve_change=false;document.getElementById("show_IPAdrReserve").style.display="none";document.getElementById("show_IPAdrReserveAlerInfo").style.display="none";document.getElementById("show_IPAdr").style.display="table-row";$("#enableReserveIP").prop("checked",false)}else{reserve_change=true;document.getElementById("show_IPAdrReserve").style.display="table-row";document.getElementById("show_IPAdrReserveAlerInfo").style.display="none";document.getElementById("show_IPAdr").style.display="none";$("#enableReserveIP").prop("checked",true)}if(wan_type_init.indexOf("Bridged")>=0||wan_type_init.indexOf("Ap")>=0||wan_type_init.indexOf("Extender")>=0||wan_type_init.indexOf("Repeater")>=0){document.getElementById("show_ReserveIP").style.display="none"}else{if(!COMM_CheckNetworkAddr(b.IPv4Address,guestzone_ip,mask)){document.getElementById("show_ReserveIP").style.display="table-row"}else{document.getElementById("show_ReserveIP").style.display="none"}}if(b.Vendor!=""){document.getElementById("client_Vendor").innerHTML=b.Vendor}else{document.getElementById("client_Vendor").innerHTML="N/A"}if(b.MacfilterEnabled){macctrl_change=true;$("#schedule").selectbox("detach");$("#schedule").val(b.ScheduleName);$("#schedule").selectbox("attach");$("#enableAccess").prop("checked",true);$("#show_Schedule").show()}else{macctrl_change=false;$("#enableAccess").prop("checked",false);$("#show_Schedule").hide()}$("#editPop").show();editType=true;editID=c}function closeEditPOP(){changeTimeoutAction();var g=$("#enableReserveIP").prop("checked");var i=$("#client_IPAdrReserve").val();var a=$("#client_Name").val();var h=$("#enableAccess").prop("checked");var f=$("#schedule").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);var d=datalist.getData(editID);d.NickName=a;if(g&&(i!="")){d.ReserveIP=i;if(reserve_change==false){Reserved_cnt++}}else{d.ReserveIP="";if(reserve_change==true){Reserved_cnt--}}d.MacfilterEnabled=h;if(h){d.ScheduleName=f;if(macctrl_change==false){MACFilter_cnt++}}else{d.ScheduleName="";if(macctrl_change==true){MACFilter_cnt--}}datalist.editData(d.rowid,d);var j=new SOAPAction();var c=new SOAPSetClientInfo();var b=new SOAPClientInfo();b.MacAddress=d.MacAddress;b.NickName=encode_char_text(d.NickName);b.ReserveIP=d.ReserveIP;c.ClientInfoLists.push(b);var e=j.sendSOAPAction("SetClientInfo",c,null);e.done(function(p){if(p.SetClientInfoResult=="ERROR_RESERVEIP_CONFLICT"){alert(I18N("j","IP address cannot be the same."));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true)}else{if(p.SetClientInfoResult=="ERROR_RESERVEIP_TOO_MANY"){alert(I18N("j","The maximum number of permitted DHCP reservations has been exceeded."));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true)}else{var o=new SOAPAction();var m=new SOAPSetMACFilters2();for(var n in datalist.list){if(datalist.list[n].MacfilterEnabled){var l=new SOAPMacInfo();l.DeviceName=encode_char_text(datalist.list[n].NickName);l.MacAddress=datalist.list[n].MacAddress;l.ScheduleName=encode_char_text(datalist.list[n].ScheduleName);m.MACList.push(l)}}var k=o.sendSOAPAction("SetMACFilters2",m,null);k.done(function(q){if(q.SetMACFilters2Result=="ERROR_MACLIST_TOO_MANY"){alert(I18N("j","The rules exceed maximum."));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true)}});resetRulePOP()}}})}function closeAddPOP(){changeTimeoutAction();var n=$("#enableReserveIP").prop("checked");var p=$("#client_IPAdrReserve").val();var b=$("#client_Name").val();var o=$("#enableAccess").prop("checked");var j=$("#schedule").val();var m=$("#client_editMac").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);if(n&&(p!="")){if(!COMM_ValidV4Format(p)||!COMM_ValidV4Addr(p)){document.getElementById("IPAdrReserve_Info").style.display="";return}for(var r in datalist.list){var h=datalist.list[r];if(h.IPv4Address==p){document.getElementById("IPAdrReserve_Info").style.display="";return}}}if(COMM_IsMAC(m)==false){document.getElementById("MACAddress_Info").innerHTML=I18N("j","err_Check_Mac");return}for(var r in datalist.list){var h=datalist.list[r];if(h.MacAddress.toLowerCase()==m.toLowerCase()){document.getElementById("MACAddress_Info").innerHTML=I18N("j","err_mac_conflict");return}}var q=new SOAPAction();var k=null;var a=null;var g=0;if(n){var d=new SOAPSetClientInfo();var c=new SOAPClientInfo();c.MacAddress=m;c.NickName=encode_char_text(b);c.ReserveIP=p;d.ClientInfoLists.push(c);k=q.sendSOAPAction("SetClientInfo",d,null);Reserved_cnt++;k.done(function(i){if(i.SetClientInfoResult=="ERROR_RESERVEIP_CONFLICT"){alert(I18N("j","IP address cannot be the same."));$("#check_btn").attr("class","styled_button_s").prop("disabled",false);g=1}else{if(i.SetClientInfoResult=="ERROR_RESERVEIP_TOO_MANY"){alert(I18N("j","The maximum number of permitted DHCP reservations has been exceeded."));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);g=1}}})}if(o){var l=new SOAPSetMACFilters2();for(var f in datalist.list){if(datalist.list[f].MacfilterEnabled){var c=new SOAPMacInfo();c.DeviceName=datalist.list[f].DeviceName;c.MacAddress=datalist.list[f].MacAddress;c.ScheduleName=encode_char_text(datalist.list[f].ScheduleName);l.MACList.push(c)}}var e=new SOAPMacInfo();e.DeviceName=encode_char_text(b);e.MacAddress=m;e.ScheduleName=encode_char_text(j);l.MACList.push(e);a=q.sendSOAPAction("SetMACFilters2",l,null);MACFilter_cnt++;a.done(function(i){if(i.SetMACFilters2Result=="ERROR_MACLIST_TOO_MANY"){alert(I18N("j","The rules exceed maximum."));$("#check_btn").attr("class","styled_button_dis").prop("disabled",true);g=1}})}$.when(k,a).done(function(i){if(g==0){resetRulePOP()}})}function clearCreateRulePOP(){changeTimeoutAction();resetRulePOP()}function resetRulePOP(){Get_ClientInfo().done(function(){$("#editPop").hide();$("input").val("");$("#editMac_Info").hide();$("select").selectbox("detach");$("#schedule").val("Always");$("select").selectbox("attach");$("#client_IPAdrReserve_warning").remove();var a=$("#client_form").validate();a.resetForm();$("#client_form input").removeClass("error")})}function getClientList(a){if(a=="Host"){$("#client_btn_Blocked").attr("class","v4v6_linkstyle_2");$("#client_btn_Guest").attr("class","v4v6_linkstyle_2");$("#client_btn_Host").attr("class","v4v6_linkstyle_1")}else{if(a=="Guest"){$("#client_btn_Blocked").attr("class","v4v6_linkstyle_2");$("#client_btn_Guest").attr("class","v4v6_linkstyle_1");$("#client_btn_Host").attr("class","v4v6_linkstyle_2")}else{$("#client_btn_Blocked").attr("class","v4v6_linkstyle_1");$("#client_btn_Guest").attr("class","v4v6_linkstyle_2");$("#client_btn_Host").attr("class","v4v6_linkstyle_2")}}Client_Type=a;Get_ClientInfo()}function buttonStyleChange(){var a=true;changeTimeoutAction();if(editType==true){if(($("#enableReserveIP").prop("checked")==true)&&($("#client_IPAdrReserve").val()=="")){a=false}}else{if($("#client_editMac").val()==""){a=false}if(($("#enableReserveIP").prop("checked")==false)&&($("#enableAccess").prop("checked")==false)){a=false}if(($("#enableReserveIP").prop("checked")==true)&&($("#client_IPAdrReserve").val()=="")){a=false}}if(a){$("#check_btn").attr("class","styled_button_s").prop("disabled",false)}else{$("#check_btn").attr("class","styled_button_dis").prop("disabled",true)}}function setEvents(){$("#enableReserveIP").on("change",function(a){buttonStyleChange();if($(this).prop("checked")){$("#show_IPAdrReserve").show()}else{$("#show_IPAdrReserve").hide()}});$("#enableAccess").on("change",function(a){buttonStyleChange();if($(this).prop("checked")){$("#show_Schedule").show()}else{$("#show_Schedule").hide()}})}function setClientValidate(){$.validator.addMethod("checkIP",function(b,a){if(b==""){return true}if(!COMM_ValidV4Format(b)||!COMM_ValidV4Addr(b)){return false}return true},jQuery.validator.messages.address_Check);$.validator.addMethod("checkMac",function(b,a){if(COMM_IsMAC(b)==false){return false}return true},jQuery.validator.messages.mac_Check);$.validator.addMethod("checkMacConflict",function(b,a){for(var d in datalist.list){var c=datalist.list[d];if(c.MacAddress.toLowerCase()==b.toLowerCase()){return false}}return true},jQuery.validator.messages.mac_Conflict);$.validator.addMethod("checkIPConflict",function(b,a){for(var d in datalist.list){var c=datalist.list[d];if((editType==true)&&(editID==c.rowid)){continue}if((b!="")&&(c.ReserveIP==b)){return false}}return true},jQuery.validator.messages.ip_Conflict);$.validator.addMethod("checkNetworkAddr",function(b,a){if(b==""){return true}if(!COMM_CheckNetworkAddr(b,lanip,mask)&&!COMM_CheckNetworkAddr(b,guestzone_ip,mask)){return false}return true},jQuery.validator.messages.check_NetworkAddr);$("#client_form").validate({rules:{client_editMac:{checkMac:true,checkMacConflict:true},client_IPAdrReserve:{checkIP:true,checkIPConflict:true,checkNetworkAddr:true}},submitHandler:function(a){if(editType==true){closeEditPOP()}else{closeAddPOP()}},unhighlight:function(c,a,b){$(c).removeClass(a).addClass(b);if((c==$("input#client_IPAdrReserve")[0])&&(editType==true)){$("#client_IPAdrReserve_warning").remove();var d=datalist.getData(editID);if((c.value)&&(c.value!=d.ReserveIP)){$(c).after("<div id='client_IPAdrReserve_warning' style='color:#00f;fone-size:12px' />");$("#client_IPAdrReserve_warning").html(I18N("j","It will take effect after reconnecting"))}}},highlight:function(c,a,b){$(c).addClass(a).removeClass(b);if(c==$("input#client_IPAdrReserve")[0]){$("#client_IPAdrReserve_warning").remove()}},errorPlacement:function(a,b){a.insertAfter(b).css("display","inline")}})};