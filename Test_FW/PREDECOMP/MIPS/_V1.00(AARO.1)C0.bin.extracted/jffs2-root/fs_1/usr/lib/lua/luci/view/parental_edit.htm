<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008 Jo-Philipp Wich <xm@leipzig.freifunk.net>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id: header.htm 4891 2009-06-22 10:23:21Z jow $

-%>
<%
require("luci.i18n").loadc("default")
local i18n = require("luci.i18n")
require("luci.http").prepare_content("text/html")
uci=require("luci.model.uci").cursor()
local lang = uci:get("system","main","language")
i18n.load("admin-core",lang)
i18n.setlanguage(lang)
-%>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta http-equiv="Pragma" content="no-cache">
<title>Untitled Document</title>
<script type="text/javascript" src="<%=media%>/easy/js/jquery-1.2.6.js"></script>
<script type="text/javascript" src="<%=media%>/easy/js/parental_control.js"></script>
<link href="<%=media%>/css/expert.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="<%=media%>/js/baseJS.js" ></script>


<%
   local luaSRules = {}
   local config = "parental_netservice" .. rule
   uci:foreach( "parental", config, function( section )
      if not ( nil == section.name ) then
         local tmp = section
         
         tmp.id = section[ '.name' ]
         table.insert( luaSRules, tmp )
      end
   end )
   
%>

<script language="JavaScript" type="text/javascript">
var D_NUM = 32;
var jsEditNo = "";
function JSSRoute( id, name, proto, port)
{
   this.id = id;
   this.name = name;
   this.proto = proto
   this.port = port;

}


var jsSRoutes = [
   <%
      for name, info in pairs(luaSRules) do
         %> new JSSRoute( "<%= info.id %>", "<%= info.name %>", "<%= info.proto %>", "<%= info.port %>" ), <%
      end
   %>
];

function backToList2()
{
   document.getElementById( "edit" ).style.display="none";
   document.getElementById( "tabs" ).style.display="block";
   document.getElementById( "list" ).style.display="block";

}

function backToList()
{
   var submit_url = '<%=luci.dispatcher.build_url("expert", "configuration", "security", "ParentalControl")%>';
	var loc = submit_url;
	var code = 'location="' + loc + '"';
    eval(code);
}

function checkIPFormat( value )
{
  return /^([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])(\.([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])){3}$/.test( value )
}

function submitEdit2()
{
	for(var i=0; i < <%=#luaSRules%>; i++){
		if(document.forms[0].service_name.value == jsSRoutes[ i ].name) {
			if(i!=jsEditNo){
				alert( "Service is exist" );
				return false;
			}
		}
	}
	if(document.forms[0].service_name.value == "UserDefined") {
		if ( document.getElementsByName( "service_port" )[0].value != "" )
		{
			return true;
		}
		else
		{
			alert( "Port must be in a Number" );
			return false;
		}
   }
}
function submitEdit()
{
	if (document.getElementsByName( "StartHour" )[0].value > document.getElementsByName( "EndHour" )[0].value ) {
		alert("<%:sch_warn1%>");
               return false;
	}else if(document.getElementsByName( "StartHour" )[0].value == document.getElementsByName( "EndHour" )[0].value) {
		if (document.getElementsByName( "StartMin" )[0].value > document.getElementsByName( "EndMin" )[0].value ) {
			alert("<%:sch_warn1%>");
               return false;
		}
	}else{
		showFullPath(' <%:Security%> > <%:parental_control%> ');
	}

	if ( /^\w{1,}$/.test( document.getElementsByName( "rule_name" )[0].value ) )
	{
		if (document.SRForm.Date_Mon.checked == "" ){	
			if (document.SRForm.Date_Tue.checked == "" ){	
				if (document.SRForm.Date_Wed.checked == "" ){	
					if (document.SRForm.Date_Thu.checked == "" ){	
						if (document.SRForm.Date_Fri.checked == "" ){	
							if (document.SRForm.Date_Sat.checked == "" ){	
								if (document.SRForm.Date_Sun.checked == "" ){	
									alert("Please select at least a day.");
									return false;
								}
							}
						}
					}
				}
			}
		}
	}
	else
	{
		alert( "<%:Route_Error_1%>" );
		return false;
	}
}
function editSR( entryNo )
{
   document.getElementById( "tabs" ).style.display="none";
   document.getElementById( "list" ).style.display="none";
   document.getElementById( "edit" ).style.display="block";

   document.getElementsByName( "SRSubmitType" )[0].value = "edit";
   jsEditNo = entryNo;
   repaintEdit();
}

function repaintEdit()
{
   if ( jsEditNo != 'New' )
   {
      document.getElementsByName( "service_name" )[0].value = jsSRoutes[ jsEditNo ].name;
      document.getElementsByName( "service_proto" )[0].value = jsSRoutes[ jsEditNo ].proto;
      document.getElementsByName( "SREditID" )[0].value = jsSRoutes[ jsEditNo ].id;
	  doServiceChange()
      document.getElementsByName( "service_port" )[0].value = jsSRoutes[ jsEditNo ].port;
	  
      showFullPath(' <%:Security%> > <%:parental_control%> ');
   }
   else
   {
      document.getElementsByName( "service_name" )[0].value = "UserDefined";
      document.getElementsByName( "service_proto" )[0].value = "TCP";
      document.getElementsByName( "service_port" )[0].value = "";
      document.getElementsByName( "SREditID" )[0].value = 'New';
      doServiceChange()
      showFullPath(' <%:Security%> > <%:parental_control%> ');
   }
}
function sumbitTable()
{
   showWebMessage( 0 , '<%:Message%>' , '<%:Ready%>' );
   return true;
} 
function show_div(show,id) {
	if(show)
		document.getElementById(id).style.display = "block" ;
	else
		document.getElementById(id).style.display = "none" ;
}
function initAll()
{	
	show_div(false, "div_wpapsk_compatible");
	if (document.SRForm.src_select.value == "Custom" ){	
			show_div(true, "div_wpapsk_compatible");
	}
	if (document.SRForm.src_select.value == "Custom" ){	
		document.getElementsByName( "src_select" )[0].value = "Custom";
	}else if (document.SRForm.src_select.value == "All"){
		document.getElementsByName( "src_select" )[0].value = "All";
	}else{
		document.SRForm.src_select.selectedIndex="<%=selectindx%>"
	}
}

function doTimeChange(selectedindex)
{
	if (document.SRForm.EndHour.value == "24" ){	
			document.getElementsByName( "EndMin" )[0].value = "00";
			document.forms[0].EndMin.options[1].selected=false;
	}	
	if (document.SRForm.StartHour.value == "24" ){	
			document.getElementsByName( "StartMin" )[0].value = "00";
			document.forms[0].StartMin.options[1].selected=false;
	}
}

function doUserChange(selectedindex)
{
	show_div(false, "div_wpapsk_compatible");
	if (document.SRForm.src_select.value == "Custom" ){	
			show_div(true, "div_wpapsk_compatible");
	}	
}

function CheckValue()
{
	if (document.SRForm.src_select.value == "Custom" ){	
		var re = /[A-Fa-f0-9][ACEace02468]:[A-Fa-f0-9]{2}:[A-Fa-f0-9]{2}:[A-Fa-f0-9]{2}:[A-Fa-f0-9]{2}:[A-Fa-f0-9]{2}/;
		if (document.SRForm.MAC_Address.value.length == 0) {
			if (document.getElementById( "edit" ).style.display == "none") {
				alert("<%:WAN_Error_18%>");
				document.SRForm.MAC_Address.focus();
				return false;
			}
		}
		if (!re.test(document.SRForm.MAC_Address.value)) {
			if (document.getElementById( "edit" ).style.display == "none") {
				alert("<%:WAN_Error_19%>");
				document.SRForm.MAC_Address.focus();
				return false;
			}
		}
	}
}
function deleteSR( entryNo, element )
{
	var submit_url = '<%=luci.dispatcher.build_url("expert","configuration","security","ParentalControl","ParentalControl_Edit")%>';
	var loc = submit_url + '?delete=' + entryNo;
	var code = 'location="' + loc + '"';
    eval(code);
}
function doServiceChange()
{
	if(document.forms[0].service_name.value == "UserDefined") {
		document.forms[0].service_proto.options[0].hidden=false;
		document.forms[0].service_proto.options[1].hidden=false;
		document.forms[0].service_proto.options[2].hidden=false;
		document.forms[0].service_proto.options[0].selected=true;
		document.forms[0].service_port.disabled=false;
	}else if(document.forms[0].service_name.value == "XboxLive") {
		document.forms[0].service_proto.options[0].hidden=true;
		document.forms[0].service_proto.options[1].hidden=false;
		document.forms[0].service_proto.options[2].hidden=false;
		document.forms[0].service_proto.options[1].selected=true;
		document.forms[0].service_port.disabled=true;
	}else if(document.forms[0].service_name.value == "ISPEC_IKE") {
		document.forms[0].service_proto.options[0].hidden=true;
		document.forms[0].service_proto.options[1].hidden=true;
		document.forms[0].service_proto.options[2].hidden=false;
		document.forms[0].service_proto.options[2].selected=true;
		document.forms[0].service_port.disabled=true;
	}else{
		document.forms[0].service_proto.options[0].hidden=false;
		document.forms[0].service_proto.options[1].hidden=true;
		document.forms[0].service_proto.options[2].hidden=true;
		document.forms[0].service_proto.options[0].selected=true;
		document.forms[0].service_port.disabled=true;
	}
	
	if(document.forms[0].service_name.value == "UserDefined") {
		document.getElementsByName( "service_port" )[0].value = "";
	}else if(document.forms[0].service_name.value == "XboxLive") {
		document.getElementsByName( "service_port" )[0].value = "3074";
	}else if(document.forms[0].service_name.value == "HTTP") {
		document.getElementsByName( "service_port" )[0].value = "80";
	}else if(document.forms[0].service_name.value == "HTTPS") {
		document.getElementsByName( "service_port" )[0].value = "443";
	}else if(document.forms[0].service_name.value == "ISPEC_IKE") {
		document.getElementsByName( "service_port" )[0].value = "500,4500";
	}else if(document.forms[0].service_name.value == "MicrosoftRemoteDesktop") {
		document.getElementsByName( "service_port" )[0].value = "3389";
	}else if(document.forms[0].service_name.value == "NetMeeting") {
		document.getElementsByName( "service_port" )[0].value = "1720";
	}else if(document.forms[0].service_name.value == "POP3") {
		document.getElementsByName( "service_port" )[0].value = "110";
	}else if(document.forms[0].service_name.value == "PPTP") {
		document.getElementsByName( "service_port" )[0].value = "1723";
	}else if(document.forms[0].service_name.value == "SMTP") {
		document.getElementsByName( "service_port" )[0].value = "25";
	}else if(document.forms[0].service_name.value == "SSH") {
		document.getElementsByName( "service_port" )[0].value = "22";
	}else {
		document.getElementsByName( "service_port" )[0].value = "5500,5800,5900-5910";
	}
	
}

</script>

</head>
<body class="bandwidth_bg"  onload="initAll();"> <!---->

<form method="post" name="SRForm" action="<%=controller%>/easy/parental_edit" onSubmit="return CheckValue()" > 
   <div id="table02">
      <ul id="list">
         <li class="table_top"></li><li class="table_content">
            <div class="data">
               <ul>
			   <li class="title" > <%:General%> </li>
			     <div class="w_text">
					 <ul>
							<%local rule_enable = uci:get("parental",rule,"enable")%>
							<li class="all_table">
							<input name="rule_enable" type="checkbox" value="1" <%if rule_enable == "1" then%>  checked="CHECKED" <%end%>/> <%:active%>
							</li>
					 </ul>
				 </div>
                  <div class="w_text">
                     <ul>
                        <li class="left_table"><%:parental_profile%> :</li>
                        <li class="right_table">
							<%local rule_name = uci:get("parental",rule,"name")%>
                           <input name="rule_name" size="20" maxlength="20" value="<%=rule_name%>" type="text" />
                        </li>
                     </ul>
                  </div>
                  
				   <ul id="div_wpapsk_compatible" style="display:none">
						<div class="w_text">
							<ul>
								<li class="left_table"><%:mac_addr%> :</li>
								<li class="right_table">
									<%local MAC_Address = uci:get("parental",rule,"src_mac")
									  local src_type = uci:get("parental",rule,"src_type")
									  if ( src_type == "single" or src_type == "all") then
									%>
									<input name="MAC_Address" size="20" maxlength="20" type="text" />
									<%else%>
									<input name="MAC_Address" size="20" maxlength="20" value="<%=MAC_Address%>" type="text" />
									<%end%>
								</li>
							</ul>
						</div>
					</ul>
				  
                  <div class="spaceair"></div>
				  <li class="space"></li>
				  <ul>
				   <li class="title" > <%:internet_access_sche%> </li>
					  <div class="w_text">
						<%local rule_weekdays = uci:get("parental",rule,"weekdays")
						  local Date_Mon=luci.sys.exec("uci get parental."..rule..".weekdays | grep Mon |sed 's/\"//g' | sed 's/://g'")
						  local Date_Tue=luci.sys.exec("uci get parental."..rule..".weekdays | grep Tue |sed 's/\"//g' | sed 's/://g'")
						  local Date_Wed=luci.sys.exec("uci get parental."..rule..".weekdays | grep Wed |sed 's/\"//g' | sed 's/://g'")
						  local Date_Thu=luci.sys.exec("uci get parental."..rule..".weekdays | grep Thu |sed 's/\"//g' | sed 's/://g'")
						  local Date_Fri=luci.sys.exec("uci get parental."..rule..".weekdays | grep Fri |sed 's/\"//g' | sed 's/://g'")
						  local Date_Sat=luci.sys.exec("uci get parental."..rule..".weekdays | grep Sat |sed 's/\"//g' | sed 's/://g'")
						  local Date_Sun=luci.sys.exec("uci get parental."..rule..".weekdays | grep Sun |sed 's/\"//g' | sed 's/://g'")
						%>
						 <ul>
							<li class="left_table"><%:sch_day%> :</li>
							<li class="right_table">
							   <input name="Date_Mon" type="checkbox" value="1" <%if not( Date_Mon == "" ) then%>  checked="CHECKED" <%end%>/> <%:monday%>
							   <input name="Date_Tue" type="checkbox" value="1" <%if not( Date_Tue == "" ) then%>  checked="CHECKED" <%end%>/> <%:tuesday%>
							   <input name="Date_Wed" type="checkbox" value="1" <%if not( Date_Wed == "" ) then%>  checked="CHECKED" <%end%>/> <%:wednesday%>
							   <input name="Date_Thu" type="checkbox" value="1"  <%if not( Date_Thu == "" ) then%>  checked="CHECKED" <%end%>/> <%:thursday%>
							</li>
						 </ul>
						 <ul>
							<li class="left_table"></li>
							<li class="right_table">
							   <input name="Date_Fri" type="checkbox" value="1"  <%if not( Date_Fri == "" ) then%>  checked="CHECKED" <%end%>/> <%:friday%>
							   <input name="Date_Sat" type="checkbox" value="1"  <%if not( Date_Sat == "" ) then%>  checked="CHECKED" <%end%>/><%:saturday%>
							   <input name="Date_Sun" type="checkbox" value="1"  <%if not( Date_Sun == "" ) then%>  checked="CHECKED" <%end%>/> <%:sunday%>
							</li>
						 </ul>
					  </div>
					  <div class="w_text">
						 <ul>
							<li class="left_table"><%:Time%> (<%:begin%> ~ <%:End%>)  :</li>
							<li class="right_table">
								<select name="StartHour" size="1" onchange="doTimeChange(this.selectedIndex);">
									<%local StartHour = uci:get("parental",rule,"start_hour")%>
									<%for j = 0, 24 do %>
										<option value="<%= string.format( "%02d", j ) %>" <%if StartHour == string.format( "%02d", j ) then%>selected="selected"<%end%>><%= string.format( "%02d", j ) %></option>                                       
                                    <%end%>                                    
                                </select>
                                (<%:sch_hour%>)&nbsp;
                                <select name="StartMin" size="1" onchange="doTimeChange(this.selectedIndex);">
									<%local StartMin = uci:get("parental",rule,"start_min")%>
                                    <option value="00" <%if StartMin == "00" then%>selected="selected"<%end%>>00</option>
                                    <option value="30" <%if StartMin == "30" then%>selected="selected"<%end%>>30 </option>
                                </select>
                                (<%:sch_min%>)&nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;
                                <select name="EndHour" size="1" onchange="doTimeChange(this.selectedIndex);">  
									<%local EndHour = uci:get("parental",rule,"stop_hour")%>
                                    <%for j = 0, 24 do%>                                     
										<option value="<%= string.format( "%02d", j ) %>" <%if EndHour == string.format( "%02d", j ) then%>selected="selected"<%end%>><%= string.format( "%02d", j ) %></option>                                          
                                    <%end%>                                      
                                </select>
                                (<%:sch_hour%>)
                                <select name="EndMin" size="1" onchange="doTimeChange(this.selectedIndex);">
									<%local EndMin = uci:get("parental",rule,"stop_min")%>
                                    <option value="00" <%if EndMin == "00" then%>selected="selected"<%end%>>00</option>
                                    <option value="30" <%if EndMin == "30" then%>selected="selected"<%end%>>30 </option>
                                </select>
                                (<%:sch_min%>)
							</li>
						 </ul>
					  </div>
					  <div class="spaceair"></div>
					</ul>
					
					
            </div>

         </li>
         <li class="table_button">
            <div class="button" align="center">
               <input name="apply" value="<%:Apply%>" type="submit" onclick="return submitEdit()" />
                  &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
				<input name="Back" value="<%:Back%>" type="submit" id="back" />
                  &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
				<input value="" name="url_str" type="hidden"></li>
            </div>
         </li>
		</ul>
   </div>
<input type="hidden" name="sta_name" id="sta_name" value="<%=staMac%>"/>	 
</form>
</body>
</html>
